{
  "name": "RangedAutoRoll",
  "type": "script",
  "author": "j6d0OeWEku7u2rFF",
  "img": "icons/svg/dice-target.svg",
  "scope": "global",
  "command": "// Use Ranged Weapon Macro Settings\nconst skipPrompt = true; // Skips Attack/Damage prompt, not reloading\nconst RollAttack = true; // Roll Attack?\nconst RollDamage = true; // Roll Damage?\nconst DoNotifyShotsLeft = true; // Notify the user the amount of shots the token's weapon has left?\nconst DoNotifyReload = true; // Notify the user the token has to reload\n\n// Macro Body\n\nMain()\n\nfunction Main()\n{\n    let myActor = GetActor();\n    if (myActor)\n    {\n        const EquippedRangedWeapons = GetEquippedRangedWeapons(myActor);\n        if (EquippedRangedWeapons.length > 0)\n            UseWeapon(EquippedRangedWeapons[0]);\n        else\n             ui.notifications.warn( \"[\" + myActor.name + \"] has no ranged weapon equipped!\");\n    }\n    else\n    {\n        ui.notifications.warn(\"Please select a token!\");\n    }\n}\n\nasync function UseWeapon(Weapon)\n{\n    const WeaponHasAmmo = Weapon.system.magazine.value != 0;\n    if (WeaponHasAmmo)\n    {\n        FireWeapon(Weapon); \n        \n        NotifyWeaponInfo(Weapon);\n    }\n    else\n    {\n        // Reload\n        await Weapon._loadItem();\n    }\n}\n\nfunction NotifyWeaponInfo(Weapon)\n{\n    const HasAmmoLeft = Weapon.system.magazine.value >= 1;\n    \n    if (DoNotifyShotsLeft && HasAmmoLeft)\n    {\n        const ShotString = Weapon.system.magazine.value == 1 ? \" shot left\" : \" shots left\";\n        ui.notifications.info(Weapon.system.magazine.value + ShotString);\n    }\n    else if (DoNotifyReload && !HasAmmoLeft)\n    {\n        ui.notifications.warn(\"You shot your load, NOW RELOAD!\");\n    }\n}\n\nasync function FireWeapon(Weapon)\n{\n    if (RollAttack)\n    {\n        const rollType = \"attack\";\n        await game.cpr.macro.rollItemMacro(Weapon.name, {skipPrompt, rollType});\n    }\n    if (RollDamage)\n    {\n        const rollType = \"damage\";\n        await game.cpr.macro.rollItemMacro(Weapon.name, {skipPrompt, rollType});\n    }   \n}\n\nfunction GetActor()\n{\n    let myActor;\n    if (speaker.token) myActor = game.actors.tokens[speaker.token];\n    if (!myActor) myActor = game.actors.get(speaker.actor);\n    if (!myActor)\n    {\n        return;\n    }\n    \n    return myActor;\n}\n\nfunction GetEquippedRangedWeapons(myActor)\n{\n    const weapons = myActor.itemTypes.weapon;\n    return weapons.filter((a) => a.system.equipped == \"equipped\" && a.system.isRanged);\n}",
  "flags": {
    "combat-utility-belt": {
      "macroTrigger": ""
    },
    "advanced-macros": {
      "runAsGM": false,
      "runForEveryone": false,
      "runForSpecificUser": ""
    },
    "exportSource": {
      "world": "cyberpunk-red",
      "system": "cyberpunk-red-core",
      "coreVersion": "10.291",
      "systemVersion": "v0.86.1"
    }
  },
  "_stats": {
    "systemId": "cyberpunk-red-core",
    "systemVersion": "v0.86.1",
    "coreVersion": "10.291",
    "createdTime": 1679774547681,
    "modifiedTime": 1679774565550,
    "lastModifiedBy": "j6d0OeWEku7u2rFF"
  }
}